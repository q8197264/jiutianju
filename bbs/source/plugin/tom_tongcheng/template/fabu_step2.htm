<!DOCTYPE html><html>
<head>
<!--{if $isGbk}-->
<meta http-equiv="Content-Type" content="text/html; charset=GBK">
<!--{else}-->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--{/if}-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<title>{$modelInfo['name']} - {$__SitesInfo['name']}</title>
<link rel="stylesheet" href="source/plugin/tom_tongcheng/images/style.css?v={$cssJsVersion}" />
<link rel="stylesheet" href="source/plugin/tom_tongcheng/images/mobiscroll/mobiscroll.css" />
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/jquery-1.8.3.min.js"></script>
<script type="text/javascript">
    var commonjspath = 'source/plugin/tom_tongcheng/images';
</script>
<script src="source/plugin/tom_tongcheng/images/common.js?v={$cssJsVersion}" type="text/javascript"></script>
</head>
<body>
<header class="header header-index on in2">
   <section class="wrap">
       <section class="sec-ico go-back" onclick="history.back();">{lang tom_tongcheng:back}</section>
        <h2>{lang tom_tongcheng:fabu_step2_title_1}{$typeInfo['name']}{lang tom_tongcheng:fabu_step2_title_2}</h2>
        <section class="sec-ico btn slide-btn">
            <a href="plugin.php?id=tom_tongcheng&site={$site_id}&mod=article">{lang tom_tongcheng:fabu_xuzhi_title}</a>
        </section>
   </section>
</header>
<form class="mainer" name="payForm" id="payForm" >
   <section class="wrap edit-form">
        <!--{if $typeInfo['warning_msg']}-->
        <div class="tcui-cells__title">
             <section style="padding:10px;background: #eff9ff;line-height:1.5;letter-spacing: 1px;">
                <p style="color:#f8a543">{$typeInfo['warning_msg']}</p>
             </section>
        </div>
       <!--{/if}-->
        <section class="edit-item">
            <!--{if $cateList}-->
             <section class="input-control ">
                  <span>{$typeInfo['cate_title']}</span>
                  <section class="user-fav">
                       <section class="sec-input">
                            <select name="cate_id" id="cate_id" class="tcui-select">
                                <!--{loop $cateList $key $val}-->
                                <option value="{$val['id']}"> {$val['name']}</option>
                                <!--{/loop}-->
                            </select>
                       </section>
                       <div class="frt">
                            <div class="right-arrow"></div>
                       </div>
                  </section>
             </section>
            <!--{/if}-->
            <!--{if $attrList}-->
            <!--{loop $attrList $key $val}-->
                <section class="input-control ">
                      <span>{$val['name']}</span>
                      <input type="hidden" name="attrname_{$val['id']}" value="{$val['name']}">
                      <section class="user-fav">
                           <section class="sec-input">
                               <!--{if $val['type'] == 1}-->
                               <input type="text" name="attr_{$val['id']}" id="attr_{$val['id']}" placeholder="{$val['name']}" value=""  />
                               <!--{/if}-->
                               <!--{if $val['type'] == 2}-->
                               <select name="attr_{$val['id']}" id="attr_{$val['id']}" class="tcui-select" >
                                    <!--{loop $val['list'] $kk $vv}-->
                                    <option value="{$vv}">{$vv}</option>
                                    <!--{/loop}-->
                                </select>
                               <!--{/if}-->
                               <!--{if $val['type'] == 3}-->
                               <input class="tcui-input" type="datetime-local" name="attrdate_{$val['id']}" id="attrdate_{$val['id']}" value="" max="{$maxDateTime}" min="{$minDateTime}" />
                               <input type="hidden" name="attrdatetmp_{$val['id']}" id="attrdatetmp_{$val['id']}" value="">
                               <!--{/if}-->
                           </section>
                           <div class="frt"></div>
                      </section>
                 </section>
            <!--{/loop}-->
            <!--{/if}-->
            <section class="input-control " <!--{if $modelInfo['area_select'] == 0  }-->style="display: none;"<!--{/if}-->>
                 <span>{lang tom_tongcheng:fabu_step2_city}</span>
                 <section class="user-fav">
                      <section class="sec-input">
                           <div id="choseCity"><font color="#8e8e8e">{lang tom_tongcheng:fabu_step2_city_msg}</font></div>
                           <input type="hidden" name="area_id" id="area_id" value="">
                           <input type="hidden" name="street_id" id="street_id" value="">
                      </section>
                      <div class="frt"></div>
                 </section>
            </section>
             <section class="input-control clear bb0">
                  <div style="line-height: 3em;">{$typeInfo['desc_title']}</div>
                  <section class="textarea">
                       <section class="sec-input">
                            <textarea name="content" id="content" maxlength="1000" placeholder="{$typeInfo['desc_content']}"></textarea>
                       </section>
                  </section>
             </section>
            <!--{if $tagList}-->
             <section class="input-control clear input-control-hide-title">
                  <span>-</span>
                  <section class="user-fav">
                       <section class="sec-input small-line">
                            <div data-max="5">
                                 <!--{loop $tagList $key $val}-->
                                 <input type="checkbox" id="check-fuli-{$val['id']}" name="tag[]" value="{$val['id']}" class="file-hide checkbox-label-item" />
                                 <label for="check-fuli-{$val['id']}">{$val['name']}</label>
                                 <input type="hidden" name="tagname_{$val['id']}" value="{$val['name']}">
                                 <!--{/loop}-->
                            </div>
                       </section>
                  </section>
             </section>
            <!--{/if}-->
             <section class="input-control ">
                  <ul>
                      <div id="photolist" class="clearfix"></div>
                       <li>
                            <section class="img pic-upload-btn" id="picpic-btn">
                                <input type="file" name="filedata1" id="filedata1" class="post-upload-fileprew"  />
                                <img src="source/plugin/tom_tongcheng/images/img7.png" />
                            </section>
                       </li>
                       <li class="li_text"><span>{lang tom_tongcheng:fabu_step2_photo_1}{$tongchengConfig['max_photo_num']}{lang tom_tongcheng:fabu_step2_photo_2} </span></li>
                  </ul>
             </section>
        </section>
        <section class="input-control ">
             <span>{lang tom_tongcheng:fabu_step2_xm}</span>
             <section class="user-fav">
                  <section class="sec-input">
                       <input type="text" name="xm" id="xm" placeholder="{lang tom_tongcheng:fabu_step2_xm_msg}" value="{$defaultXm}" />
                  </section>
                  <div class="frt"></div>
             </section>
        </section>
        <section class="input-control ">
             <span>{lang tom_tongcheng:fabu_step2_tel}</span>
             <section class="user-fav">
                  <section class="sec-input">
                       <input type="text" name="tel" id="tel" placeholder="{lang tom_tongcheng:fabu_step2_tel_msg}" value="{$defaultTel}"  />
                  </section>
                  <div class="frt"></div>
             </section>
        </section>
        <section class="input-control">
             <span class="slide-btn" data-target="advance-slide" data-html="1">{lang tom_tongcheng:fabu_step2_tiaok_title}</span>
             <section>
                 <input type="checkbox" name="xieyi" id="xieyi" value="1" checked/> <a href="plugin.php?id=tom_tongcheng&site={$site_id}&mod=article">{lang tom_tongcheng:fabu_step2_agree_msg}</a> 
             </section>
        </section>
   </section>
   <section class="btn-group-block">
       <!--{if $fabuPayStatus == 1}-->
       <button type="button" id="id_fabu_btn" class="id_fabu_btn">{lang tom_tongcheng:fabu_step2_pay_btn}{$typeInfo['fabu_price']}</button>
       <!--{else}-->
       <button type="button" id="id_fabu_btn" class="id_fabu_btn">{lang tom_tongcheng:fabu_step2_fabu_btn}</button>
       <!--{/if}-->
        <input type="hidden" name="formhash" value="{$formhash}">
        <input type="hidden" name="model_id" value="{$typeInfo['model_id']}">
        <input type="hidden" name="type_id" value="{$type_id}">
        <input type="hidden" name="user_id" value="{$__UserInfo['id']}">
        <input type="hidden" name="city_id" id="city_id" value="{$__CityInfo['id']}">
        <div class="clear10"></div>
        <div class="clear10"></div>
        <div class="clear10"></div>
   </section>
</form>
<section class="dialog succ-dialog id-fabu-succ" style="display: none;">
   <section class="dialog-wrap">
        <section class="dialog-center">
            <a href="javascript:void(0);" onclick="hideFabuSucc();" class="group-link close"></a>
             <section class="dialog-body">
                  <h1>{lang tom_tongcheng:fabu_step2_succ_title}</h1>
                  <p><span>{lang tom_tongcheng:fabu_step2_succ_msg_1} </span><label>{lang tom_tongcheng:fabu_step2_succ_msg_2}</label><span> {lang tom_tongcheng:fabu_step2_succ_msg_3}</span></p>
                  <section class="dialog-btns clear">
                       <a href="#" class="share-link id-share-link">{lang tom_tongcheng:fabu_step2_succ_btn_1}</a>
                       <a href="#" class="buy-link id-buy-link">{lang tom_tongcheng:fabu_step2_succ_btn_2}</a>
                  </section>
             </section>
        </section>
   </section>
</section>
<!--{if $showPhoneDialog == 1  }-->
<section class="dialog succ-dialog">
   <section class="dialog-wrap">
        <section class="dialog-center">
             <section class="dialog-body">
                  <h1>{lang tom_tongcheng:fabu_step2_phone_title}</h1>
                  <p><span>{lang tom_tongcheng:fabu_step2_phone_msg}</span></p>
                  <section class="dialog-btns clear">
                      <a href="plugin.php?id=tom_tongcheng&site={$site_id}&mod=phone" class="share-link" style="width: 90%;">{lang tom_tongcheng:fabu_step2_phone_btn}</a>
                  </section>
             </section>
        </section>
   </section>
</section>
<!--{/if}-->
<script>var city = eval(decodeURIComponent('{$cityData}'));var selectedIndex = [0, 0];</script>
<!--{if $isGbk}-->
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/mobiscroll/mobiscroll.gbk.js"></script>
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/picker/picker.min.gbk.js"></script>
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/picker/picker.fabu.gbk.js"></script>
<!--{else}-->
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/mobiscroll/mobiscroll.utf8.js"></script>
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/picker/picker.min.utf8.js"></script>
<script type="text/javascript" src="source/plugin/tom_tongcheng/images/picker/picker.fabu.utf8.js"></script>
<!--{/if}-->
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
<script>
var jsApiParameters;
var li_i = 1;
var count = 0;
var tongcheng_id    = 0;
var max_photo_num   = "{$tongchengConfig['max_photo_num']}";
max_photo_num       = max_photo_num*1;
var shareLinkUrl    = "{$shareLinkUrl}";
var buyLinkUrl      = "{$buyLinkUrl}";

function jsApiCall(){
    WeixinJSBridge.invoke(
        'getBrandWCPayRequest',{
            "appId": jsApiParameters.appId,
            "timeStamp": jsApiParameters.timeStamp,
            "nonceStr": jsApiParameters.nonceStr,
            "package": jsApiParameters.package,
            "signType": jsApiParameters.signType,
            "paySign": jsApiParameters.paySign
        },
        function(res){
            if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                loading(false);
                submintPayStatus = 0;
                showFabuSucc();
            }else{
                loading(false);
                submintPayStatus = 0;
                tusi("{lang tom_tongcheng:pay_fail}");
                setTimeout(function(){window.location.href="{$myListUrl}";},1888);
            } 
        }
    );
}

function callpay(){
    if (typeof WeixinJSBridge == "undefined"){
        if( document.addEventListener ){
            document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
        }else if (document.attachEvent){
            document.attachEvent('WeixinJSBridgeReady', jsApiCall); 
            document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
        }
    }else{
        jsApiCall();
    }
}    

var submintPayStatus = 0;
$(".id_fabu_btn").click( function (){
    if(submintPayStatus == 1){
        return false;
    }
    
    var xm          = $("#xm").val();
    var tel         = $("#tel").val();
    var content      = $("#content").val();
    var area_id      = $("#area_id").val();
    var street_id      = $("#street_id").val();
    
    if($('#xieyi').attr("checked")) {
    }else{
        tusi("{lang tom_tongcheng:fabu_step2_must_xieyi}");
        return false;
    }
    
    <!--{if $modelInfo['area_select'] == 1  }-->
    if(area_id == ""){
        tusi("{lang tom_tongcheng:fabu_step2_must_area}");
        return false;
    }
    <!--{/if}-->
    
    if(xm == ""){
        tusi("{lang tom_tongcheng:fabu_step2_must_xm}");
        return false;
    }
    <!--{if $tongchengConfig['fabu_phone_check'] == 1  }-->
    if(tel == "" || !checkMobile(tel)){
        tusi("{lang tom_tongcheng:fabu_step2_must_tel}");
        return false;
    }
    <!--{else}-->
    if(tel == ""){
        tusi("{lang tom_tongcheng:fabu_step2_must_tel}");
        return false;
    }
    <!--{/if}-->
    if(content == ""){
        tusi("{lang tom_tongcheng:fabu_step2_must}{$typeInfo['desc_title']}");
        return false;
    }
    
    if(count > max_photo_num){
        tusi("{lang tom_tongcheng:fabu_step2_over_photo}");
        return false;
    }
    
    loading('{lang tom_tongcheng:doing}');
    submintPayStatus = 1;
    $.ajax({
        type: "POST",
        url: "{$payUrl}",
        dataType : "json",
        data: $('#payForm').serialize(),
        success: function(data){
            loading(false);
            if(data.status == 200) {
                tongcheng_id = data.tongcheng_id;
                <!--{if $fabuPayStatus == 1}-->
                jsApiParameters = data.parameters;
                setTimeout(function(){callpay();},500);
                <!--{else}-->
                submintPayStatus = 0;
                showFabuSucc();
                <!--{/if}-->
            }else if(data.status == 301){
                tusi("{lang tom_tongcheng:fabu_step2_error_301}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else if(data.status == 303){
                tusi("{lang tom_tongcheng:pay_error_303}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else if(data.status == 304){
                tusi("{lang tom_tongcheng:pay_error_304}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else if(data.status == 305){
                tusi("{$tongchengConfig['fabu_next_minute']}{lang tom_tongcheng:pay_error_305}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else if(data.status == 404){
                tusi("{lang tom_tongcheng:fabu_step2_error_404}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else if(data.status == 500){
                tusi("{lang tom_tongcheng:fabu_step2_error_500}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else if(data.status == 505){
                submintPayStatus = 0;
                tusi("{lang tom_tongcheng:fabu_step2_error_505}"+data.word);
                //setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }else{
                tusi("{lang tom_tongcheng:fabu_step2_error}");
                setTimeout(function(){window.location.href=window.location.href+"&prand={$prand}";},1888);
            }
        }
    });
});

function showFabuSucc(){
    $(".id-share-link").attr("href",shareLinkUrl+tongcheng_id); 
    $(".id-buy-link").attr("href",buyLinkUrl+tongcheng_id); 
    $(".id-fabu-succ").show();
    return false;
}

function hideFabuSucc(){
    //$(".id-fabu-succ").hide();
    setTimeout(function(){window.location.href="{$myListAllUrl}";},1);
    return false;
}

function checkMobile(s){
    var regu =/^[1][3|8|4|5|7][0-9]{9}$/;
	var re = new RegExp(regu);
	if (re.test(s)) {
		return true;
	}else{
		return false;
	}
}

$(document).ready(function() {
    var a = (new Date).getFullYear();
    $("input[type=date]").each(function() {
        $(this).mobiscroll().date({
            startYear: a - 60,
            endYear: a + 10
        })
    }),
    $("input[type=datetime-local]").mobiscroll().datetime({
        startYear: a - 60,
        endYear: a + 10
    })
});

function picremove(i){
    $(".li_"+i).remove();
    count--;
}

$(document).on("click", ".checkbox-label-item",function() {
    var t = $(this).parent(),
    a = parseInt(t.data("max"), 10) || 0;
    a > 0 && $(this).is(":checked") && t.find("input:checked").length > a && ($(this).prop("checked", !1), tusi("{lang tom_tongcheng:fabu_step2_only_choose_1}" + a + "{lang tom_tongcheng:fabu_step2_only_choose_2}"))
});
</script>
{template tom_tongcheng:new_upload}
</body>
</html>